import type { InfiltrationSolverFunction } from "$src/exploits/infiltration/solvers/keyCodes";
import { KeyCodes } from "$src/exploits/infiltration/solvers/keyCodes";
import type { InfiltrationMocks } from "$src/exploits/infiltration/InfiltrationMocks";
import { doc } from "$src/automation/exploits/references";
import { asyncWait } from "$server/utils/asyncUtils";

export const attackGuard: InfiltrationSolverFunction = async (
  mocks: InfiltrationMocks,
  infiltrationBody: HTMLElement,
) => {
  let preparingNode = doc.evaluate(`//h4[text()="Preparing?"]`, doc).iterateNext();
  while (!preparingNode && infiltrationBody.isConnected) {
    await asyncWait(10);
    preparingNode = doc.evaluate(`//h4[text()="Preparing?"]`, doc).iterateNext();
  }

  await asyncWait(50);
  if (infiltrationBody.isConnected) await mocks.enterKey(KeyCodes.SPACE);
};
